<?php
	if (!$arLoginMessage) {
		$arLoginMessage=$ARnls["loginrequired"];
	}
	global $nocache;
	$nocache=true;
	// now make sure that the login template can use public resources:
	// remember the failed login user
	if ($ARCurrent->session) {
		$arLoginOld=$ARCurrent->session->get("ARLogin");
		$arPasswordOld=$ARCurrent->session->get("ARPassword");
		if (is_string($arCallArgs)) {
			$arCallArgs.="&arLoginOld=".RawUrlEncode($arLoginOld);
		} else if (is_array($arCallArgs)) {
			$arCallArgs=array_merge($arCallArgs, Array("arLoginOld" => $arLoginOld));
		}
		// when current user is logged on as public, then don't delete his
		// session.
		if ($AR->user && ($AR->user->data->login!="public")) {
			// now set the user back to 'public'
			$temp=$this->get("/system/users/public","system.get.phtml");
			if ($temp && $temp[0]) {
				$AR->user=$temp[0];
				$AR->user->grants=$this->GetValidGrants();
				// do not update the cookie and session data
				// cookies must be set only by login.phtml
				// just kill the session
				// $ARCurrent->session->kill();
				$ARCurrent->session->put("ARLogin","public");
				$ARCurrent->session->put("ARPassword","none");
			}
		}
	}
	if ($this->CheckConfig($arCallFunction, $arCallArgs)) {
?>
<html>
<head>
<title>Ariadne - <?php echo $arLoginMessage; ?></title>
<style>
	.width100 { width: 100; }
	.width200 { width: 200; }
	.width300 { width: 300; }
	H1		{ FONT: 12pt sans-serif; FONT-WEIGHT: bold; }
	TD				{ FONT: 10pt sans-serif; }
	BODY			{ FONT: 10pt sans-serif;
							BORDER: 0;
	<?php
		global $HTTP_USER_AGENT;
		if (eregi(".*msie ([0-9]+).*",$HTTP_USER_AGENT, $regs) &&
			 $regs[1] && (intval($regs[1])>=4)) { //ie4+
	?>
							BACKGROUND-COLOR: buttonface;
	<?php
		} else {
	?>
							BACKGROUND-COLOR: #BBBBBB;
	<?php
		}
	?>
						}
</style>
</head>
<body bgcolor="#BBBBBB">
<form name="login" method="POST" action="<?php echo $this->make_url(); ?>login.phtml">
<?php
	global $PATH_INFO, $QUERY_STRING; 
	if (!$arReturnPath) {
		$split=strrpos($PATH_INFO, "/");
		$function=substr($PATH_INFO,$split+1);
		$arReturnPath=$this->path;
	}
	if (!$arReturnTemplate) {
		$arReturnTemplate=$function;
		if ($QUERY_STRING) {
			$arReturnTemplate.="?$QUERY_STRING";
		}
	}
?>
<input type="hidden" name="arReturnPath" value="<?php echo $arReturnPath; ?>">
<input type="hidden" name="arReturnTemplate" value="<?php echo $arReturnTemplate; ?>">
<table align="center" border="0" width="300">
<tr>
	<td align="center" colspan="2">
		<h1><?php echo $arLoginMessage; ?></h1>
	</td>
</tr><tr>
	<td colspan="2" align="center">
		<fieldset><br>
			<table width="50%" align="center">
			<tr>
				<td align="right"><?php echo $ARnls["login"]; ?>&nbsp;:</td>
				<td><input type="text" name="ARLogin" size="16"></td>
			</tr><tr>
				<td align="right"><?php echo $ARnls["password"]; ?>&nbsp;:</td>
				<td><input type="password" name="ARPassword" size="16"></td>
			</tr>
			</table>
			<br>
		</fieldset>
	</td>
</tr><tr>
	<td colspan="2">&nbsp;</td>
</tr><tr>
	<td><input type="button" class="width100" name="cancel" value="<?php echo $ARnls["cancel"]; ?>" onClick="history.back();"></td>
	<td align="right"><input type="submit" class="width100" name="ok" value="&nbsp;<?php echo $ARnls["ok"]; ?>&nbsp;"></td>
</tr>
</table>
</form>
<script>
	document.login.ARLogin.focus();
</script>
</body>
</html>
<?php
	}
	if ($ARCurrent->session && $arLoginOld && $arPasswordOld) {
		$ARCurrent->session->put("ARLogin",$arLoginOld);
		$ARCurrent->session->put("ARPassword",$arPasswordOld);
	}
?>