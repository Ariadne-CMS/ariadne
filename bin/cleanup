#!/usr/bin/php -q
<?php
	$ariadne = "../lib";
	if (!@include_once($ariadne."/configs/ariadne.phtml")) {
		chdir(substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/')));
		if(!include_once($ariadne."/configs/ariadne.phtml")){
			echo "could not open ariadne.phtml";
			exit(1);
		}

	}
	require($ariadne."/configs/store.phtml");
	require($ariadne."/configs/sessions.phtml");
	require($ariadne."/includes/loader.cmd.php");
	require($store_config['code']."stores/".$session_config["dbms"]."store.phtml");

	set_time_limit(0);

	echo "Clearing old sessions...";
	$inst_store = $session_config["dbms"]."store";
	$sessionstore=new $inst_store($root, $session_config);

	$query = "object.implements='psession' and object.lastchanged < ".(time() - $session_config["timeout"]*4);

	/* purge all expired sessions */
	while (count($sessionstore->call("system.expire.phtml","",
				$sessionstore->find("/", $query,0))) >= 100);

	echo $sessionstore->total." expired sessions removed.\n";
	$sessionstore->close();
	echo "done.\n";

	// clean up store temp directories
	if ($AR->OS=="UNIX") {
		echo "Clearing temporary files...";
		$tempdir=$store_config["files"]."temp/";
		if (file_exists($tempdir)) {
			system("find $tempdir -ctime +1 -a -mindepth 1 -name .svn -prune -o -exec rm -r {} ';'");
		}
		echo "done.\n";
	} else {
		// FIXME: so... how do you do this under windows?
	}
?>
