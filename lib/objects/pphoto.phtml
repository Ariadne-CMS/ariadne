<?php

debug("pphoto: Load","object");
include_once($this->code."objects/pfile.phtml");

class pphoto extends pfile { // definitie class

	function setFontStyle($name, $font, $pointsize, $color, $gravity="northwest", $rotate=0) {
		$this->arFontStyles[$name]["font"]=$font;
		$this->arFontStyles[$name]["pointsize"]=$pointsize;
		$this->arFontStyles[$name]["color"]=$color;
		$this->arFontStyles[$name]["gravity"]=$gravity;
		$this->arFontStyles[$name]["rotate"]=$rotate;
	}

	function getThumbSettings() {
		global $ARConfig;
		return $ARConfig->cache[$this->path]->thumb;
	}

	function convert($format="jpg") {
		global $ARConfig;

		$this->set_context("mogrify");

		$result=false;
		if (eregi('[^a-z0-9+]',$format)) {
			$this->error=sprintf($ARnls["err:convillegalformat"],$format);
			// FROP $this->error="Convert called with illegal format ($format)";
		} else {
			$ARConfig->photoStack[$this->id][]=" -format $format";
			$this->targetformat=$format;
			$result=true;
		}
		return $result;		
	}

	function scale($x, $y, $fillcolor=false) {
		global $ARConfig;

		$this->set_context("mogrify");

		$x=(int)$x;
		$y=(int)$y;
		$ARConfig->photoStack[$this->id][]=" -geometry ".$x."x".$y;

		return true;
	}

	function scaledown($x, $y, $fillcolor=false) {
		global $ARConfig;

		$this->set_context("mogrify");

		$x=(int)$x;
		$y=(int)$y;
		$ARConfig->photoStack[$this->id][]=" -geometry '".$x."x".$y.">'";

		return true;
	}

	function setComposeStyle($name, $method, $width, $height, $xoffset, $yoffset, $percentage, $resize) {
		$this->arComposeStyles[$name]["method"]=$method;
		$this->arComposeStyles[$name]["width"]=$width;
		$this->arComposeStyles[$name]["height"]=$height;
		$this->arComposeStyles[$name]["xoffset"]=$xoffset;
		$this->arComposeStyles[$name]["yoffset"]=$yoffset;
		$this->arComposeStyles[$name]["percentage"]=$percentage;
		$this->arComposeStyles[$name]["resize"]=$resize;
	} 

	function compose( $target, $style="default", $blend = 0) {
		global $ARConfig;

		$this->set_context("composite");

		$compose = "";

		$method = "over";

		if( ($style!="") && ($def=$this->arComposeStyles[$style])) {
			$method = $def["method"];
			$width = $def["width"];
			$height = $def["height"];
			$xoffset = $def["xoffset"];
			$yoffset = $def["yoffset"];
			$percentage = $def["percentage"];
			$resize = $def["resize"];
		}

		$geo = false;

		if( isset( $width ) && isset( $height ) ) {
			$width=(int)abs($width);
			$height=(int)abs($height);
			$compose .= " -geometry \"".$width."x".$height;
			$geo = true;

		}
		if( isset( $xoffset ) && isset( $yoffset ) ) {
			if( !$geo ) {
				$compose .= " -geometry \"";
				$geo = true;
			}
			$xoffset=(int)$xoffset;
			$yoffset=(int)$yoffset;
			if( $xoffset < 0 ) {
				$compose .= $xoffset;
			} else {
				$compose .= "+".$xoffset;
			}
			if( $yoffset < 0 ) {
				$compose .= $yoffset;
			} else {
				$compose .= "+".$yoffset;
			}
		}

		if( $percentage ) {
			$compose .= "%";
		}
		if( $resize == ">" || $resize == "<" ) {
			$compose .= $resize;
		}
		
		if( $geo ) {
			$compose .= "\"";
		}

		if (eregi('[^a-z0-9+]',$method)) {
			$this->error=sprintf($ARnls["err:composeillegalmethod"],$method);
		} else {
			$targettype = current($this->get($target, "system.get.type.phtml"));
			if( $targettype == "pphoto" ) {
				$compose .= " -compose ".$method;
				if( $blend ) {
					$compose .= " -blend ".$blend;
				}
				$query = "object.path = '".$target."' and object.type='pphoto'";
			
				$targetid = current($this->find("/",$query, "system.get.id.phtml"));
				if( $targetid ) {
					$tmpsrc = tempnam($this->store->files."temp/", "photo");
					if(  substr( strtolower($tmpsrc), -4, 4 ) == ".tmp" ) {
						@unlink($tmpsrc);
						$tmpsrc = substr($tmpsrc, 0, -4 );
					}
					$ARConfig->photoTempFiles[$this->id][] = $tmpsrc;
					$ARConfig->photoTempFilesID[$this->id][] = $targetid;

					$tmpmysrc = tempnam($this->store->files."temp/", "photo");
					if(  substr( strtolower($tmpmysrc), -4, 4 ) == ".tmp" ) {
						@unlink($tmpmysrc);
						$tmpmysrc = substr($tmpmysrc, 0, -4 );
					}

					$ARConfig->photoTempFiles[$this->id][] = $tmpmysrc;
					$ARConfig->photoTempFilesID[$this->id][] = $this->id;

					$ARConfig->photoStack[$this->id][] = $compose." ".$tmpmysrc." ".$tmpsrc;
					$this->set_context("build");
				}
			}
		}


		return true;
	}


	function annotate($text, $x, $y, $style="default") {
		global $ARConfig;

		require_once($this->store->code."modules/mod_unicode.php");
		$text=unicode::utf8toiso8859($text);
		$this->set_context("mogrify");

		$x=(int)$x;
		$y=(int)$y;

		// Get defaults
		$font = "";
		$pointsize = 12;
		$color = "black";

		if(($style!="") && ($def=$this->arFontStyles[$style])) {
			$font = $def["font"];
			$pointsize = $def["pointsize"];
			$color = $def["color"];
			$gravity = $def["gravity"];
			$rotate = $def["rotate"];
		}
		if($font!="") {
			$font_store=$this->store->get_filestore("files");
			if($fontid=$this->exists($font)) {
				$chkfontgrants = current($this->get($font, "system.get.phtml"));
				if($chkfontgrants->CheckLogin("read")) {
					$tmpfont=$this->store->files."temp/".$fontid.".ttf";
					$font_store->copy_from_store($tmpfont, $fontid, "file");
					$ARConfig->photoStack[$this->id][]= " -font ".$tmpfont;
					$this->arClearList[]=$fontid.".ttf";
				}
			}
			$font_store->close();
		}
		$rotcmd = "";
		if($gravity!="") {
		  $gravcmd = "-gravity $gravity ";
		}
		if($rotate!=0) {
		  $rotcmd = "rotate $rotate";
		}
		$ARConfig->photoStack[$this->id][]=" -pointsize $pointsize -fill $color $gravcmd -draw '$rotcmd text $x,$y \"".addcslashes($text,ARESCAPE)."\"'";
		return true;
	}


	function set_context($context) {
		global $AR, $ARConfig;
		$unknown = false;

		if( !$ARConfig->photoContext[$this->id] ) {
			$ARConfig->photoContext[$this->id] = $context;
		}		

		if( $ARConfig->photoContext[$this->id] != $context ) {
			if( $ARConfig->photoContext[$this->id] == "mogrify" ) {
				$contextexecutable = $AR->IM->mogrify;
			} elseif( $ARConfig->photoContext[$this->id] == "composite" ) {
				$contextexecutable = $AR->IM->composite;
			} else {
				$unknown = true; // This should NOT happen
			}
			if( !$unknown && is_array($ARConfig->photoStack[$this->id])) {
				$image="";
				reset($ARConfig->photoStack[$this->id]);
				while (list($key, $value)=each($ARConfig->photoStack[$this->id])) {
					$image.=$value;
				}
				$ARConfig->photoCommandStack[$this->id][] = $contextexecutable.$image;
				unset($ARConfig->photoStack[$this->id]);
				if( $context == "build" ) {
					unset($ARConfig->photoContext[$this->id]);
				} else {
					$ARConfig->photoContext[$this->id] = $context;
				}
			}
		}
		return;
	}


	function build() {
		global $AR, $ARConfig;

		$this->set_context("build");
 
		$result=false;
		$failed=false;
		if (!$this->error) {
			$tmpsrc = tempnam($this->store->files."temp", "photo");
                        if(  substr( strtolower($tmpsrc), -4, 4 ) == ".tmp" ) {
                          @unlink($tmpsrc);
                          $tmpsrc = substr($tmpsrc, 0, -4 );
                        }

			$f_store=$this->store->get_filestore("files");
			$f_store->copy_from_store($tmpsrc, $this->id, "file");

			if( is_array($ARConfig->photoTempFiles[$this->id]) && is_array($ARConfig->photoTempFilesID[$this->id])) {
				reset($ARConfig->photoTempFiles[$this->id]);
				while( list($key, $tempfile)  = each($ARConfig->photoTempFiles[$this->id])) {
					$f_store->copy_from_store($tempfile, $ARConfig->photoTempFilesID[$this->id][$key], "file");
				}
			}

			$f_store->close();

			if (chdir($this->store->files.'temp/')) {
				if (is_array($ARConfig->photoCommandStack[$this->id])) {
					$image="";
					reset($ARConfig->photoCommandStack[$this->id]);
					while (!$failed && (list($key, $exec_string)=each($ARConfig->photoCommandStack[$this->id]))) {
						$exec_string .= " ".$tmpsrc;
						system($exec_string,$failed);
						debug("executing ($exec_string)");
						// echo( $exec_string."<br>");
					}
				}
				if (!$failed) {
					ob_start();
					if ($this->targetformat && !eregi("[^0-9a-z\._-]",$this->targetformat)) {
						$destsrc=$tmpsrc.".".$this->targetformat;
					} else {
						$destsrc=$tmpsrc;
					}
					readfile($destsrc);
					$result=ob_get_contents();
					ob_end_clean();
					@unlink($tmpsrc);
					@unlink($destsrc);
				} else {
					$this->error=sprintf($ARnls["err:noimagemagick"],$exec_string);
					// FROP $this->error="Could not run ImageMagick scale program (mogrify)<br>\n(".$exec_string.")";
				}
			} else {
				$this->error=sprintf($ARnls["err:changetempdirfailed"],$this->store->files);
				// FROP $this->error="Could not changedir to ".$this->store->files."temp/ ";
			}
		}
		if( is_array($ARConfig->photoTempFiles[$this->id])) {
			reset($ARConfig->photoTempFiles[$this->id]);
			while( list($key, $tempfile)  = each($ARConfig->photoTempFiles[$this->id])) {
				@unlink($tempfile);
			}
		}
		unset( $ARConfig->photoTempFiles[$this->id] );
		unset( $ARConfig->photoTempFilesID[$this->id] );
		unset( $ARConfig->photoCommandStack[$this->id] );
		if ($this->error) {
			echo $this->error;
		}
		return $result;
	}

	function cleanup() {
		if (is_array($this->arClearList)) {
			reset($this->arClearList);
			while (list($key, $value)=each($this->arClearList)) {
				if (!eregi("[^a-z0-9\._-]",$value)) {
					@unlink($value);
				}
			}
		}
		unset($ARConfig->photoStack[$this->id]);
	}

	function _convert($format="") {
		return $this->convert($format);
	}

	function _scale($x, $y, $fillcolor=false) {
		return $this->scale($x, $y, $fillcolor);
	}

	function _scaledown($x, $y, $fillcolor=false) {
		return $this->scaledown($x, $y, $fillcolor);
	}

	function _getThumbSettings() {
		return $this->getThumbSettings();
	}

	function _setFontStyle($name, $font, $pointsize, $color, $gravity="northwest", $rotate=0) {
		return $this->setFontStyle($name, $font, $pointsize, $color, $gravity, $rotate);
	}

	function _annotate($text, $x, $y, $style="default") {
		return $this->annotate($text, $x, $y, $style);
	}

        function _setComposeStyle($name, $method, $width, $height, $xoffset, $yoffset, $percentage, $resize) {
        	return $this->setComposeStyle($name, $method, $width, $height, $xoffset, $yoffset, $percentage, $resize);
	}

	function _compose( $target, $style="default", $blend = 0 ) {
		return $this->compose( $target, $style, $blend );
	}
 
	
	function _build() {
		return $this->build();
	}

} // end class pphoto
?>
