<?php
	/******************************************************************
	 system.save.data.phtml				 Muze Ariadne v2.1
	 ------------------------------------------------------------------
 
	******************************************************************/

	if ((($this->arIsNewObject &&
			($parentobj=current($this->get($this->parent, "system.get.phtml"))) &&
			$parentobj->CheckLogin("add", $this->type)) ||
			(!$this->arIsNewObject && $this->CheckLogin("edit"))) &&
			$this->CheckConfig()) {
		$this->call("pdir::system.save.data.phtml",$arCallArgs);
		
		// unset the properties array, so no properties can be passed to this template.
		$properties = Array();
		
		if (!$this->error) {
			$this->arIsNewObject=false;
            reset($AR->nls->list);
            $count=0;
			$clearcache=false;
            while (list($key, $value)=each($AR->nls->list)) {
                if ($name=$this->getdata("name",$key)) { // $name is the variable that must be set for a language to be available.
					$url=$this->getdata("url",$key);
					if ($url!=$this->data->$key->url) {
						$clearcache=true;					
						$this->data->$key->url=$url;
					}
					eregi('^([a-z0-9]+)://([^/:]+)(:[0-9]+)?', $url, $regs);
					$properties["url"][$count]["protocol"]=	"'".AddSlashes($regs[1])."'";
					$properties["url"][$count]["host"]=		"'".AddSlashes($regs[2])."'";
					if ($regs[3]) {
						$properties["url"][$count]["port"]=	$regs[3];
					}
					$count++;

					if (substr($this->data->$key->url,-1)=="/") {
						$this->data->$key->url=substr($this->data->$key->url,0,-1);
					}
                }
			}
			if ($clearcache) {
				// Changing the root url invalidates all cache images below this.
				$this->ClearCache();
			}
			$this->data->url=$this->data->{$this->data->nls->default}->url;

			$this->save($properties);
			$this->ClearCache();
		}
	}
?>