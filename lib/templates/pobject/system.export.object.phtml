<?php
		//$exclude_list
		$clearcachePath = '/';

		// add self to check cache
		$cpath = $this->parent;
		$newcpath=$this->store->make_path($destpath.substr($this->path, strlen($rootpath)), '..');
		if($cpath != '..' && !$ARCurrent->importStore->exists($newcpath)) {
			$arguments = $arCallArgs;
			$arguments["setDummyObject"] = true;
			$temp_obj=current($this->store->call("system.export.object.extract.phtml",
						$arguments,
						$this->store->get($cpath)));
			$temp_obj->axflags |= AX_DUMMY;
			$temp_obj->call('system.export.object.phtml',$arCallArgs);

		}

		if ($this->parent != '..' && !$this->exists($this->parent)) {
			display("Found orphaned node '".$this->path."' (skipping)\n");
			continue;
		}
		$newpath=$destpath.substr($this->path, strlen($rootpath));
		$oldpath=$this->path;
		$update_obj = false;
		$save_obj = true;

		if (is_array($exclude_list)) {
			foreach($exclude_list as $key => $excl_path) {
				if (substr($newpath, 0, strlen($excl_path)) == $excl_path) {
					$save_obj = false;
					display("Skipping path because it is in the exclude list\n");
					break;
				}
			}
		}

		if ($save_obj) {
			display("processing($newpath)	");
			if ($ARCurrent->options["without_data"]) {
				display("no data for (".$this->path.")");
				$this->axflags |= AX_WITHOUT_DATA;
			}

			if ($ARCurrent->options["without_templates"]) {
				unset($this->data->config->privatetemplates);
				unset($this->data->config->templates);
				unset($this->data->config->pinp);
				$this->axflags |= AX_WITHOUT_TEMPLATES;
			}

			if ($ARCurrent->options["without_files"]) {
				$this->axflags |= AX_WITHOUT_FILES;
			}

			if (!$saved_object[$this->id]) {
				if ((!$ARCurrent->options["force"] || ($this->axflags & (AX_DUMMY | AX_WITHOUT_DATA))) && $ARCurrent->importStore->exists($newpath)) {
					$saved_object[$this->id]=$newpath;
					// we may never overwrite an existing object with a
					// dummy object
					if (!($this->axflags & AX_DUMMY) && 
							!($this->axflags & AX_WITHOUT_DATA)) {

						$oldObject=current($ARCurrent->importStore->call("system.get.clone.phtml", $arCallArgs,
									$ARCurrent->importStore->get($newpath)));

						if (
								($this->lastchanged > $oldObject->lastchanged) || 
								( ( $oldObject->axflags & AX_DUMMY) && !($this->axflags & AX_DUMMY) )) {
							display("(updating)");
							$save_obj = true;
						} else {
							$save_obj = false;
							display("(ok)");
							unset($oldObject);	// no update needed
						}
					} else {
						display("(no overwrite)");
						$save_obj = false;
					}
				}


				if ($save_obj) {
					$clearcachePath = getCommonParent($clearcachePath,$newpath,$this->store);

					// next one has to be linked
					$saved_object[$this->id]=$newpath;

					if ($ARCurrent->importStore->exists($newpath)) {

						$ARCurrent->importStore->call(
								"system.export.update.phtml", 
								array("newObject" => $this),
								$ARCurrent->importStore->get($newpath));


					} else {
						$impObject = clone $this;
						display("(saving ".(($impObject->axflags) ? " (".$this->axflags.") " : "").")");
						$impObject->arIsNewObject = true;
						$impObject->path = $newpath;
						if ($newpath!="/") {
							$impObject->parent = $this->store->make_path($newpath, "..");
						} else {
							$impObject->parent = "..";
						}
						$impObject->store = $ARCurrent->importStore;
						$impObject->call("system.import.phtml", $arCallArgs);
						if ($impObject->error) {
							display("\n	ERROR (".$impObject->error.")\n");
							$exclude_list[] = $impObject->path;
							continue;
						}
					}
				}

				if (!($this->axflags & AX_DUMMY)) {
					$clearcachePath = getCommonParent($clearcachePath,$newpath,$this->store);

					$this->newObject=current(
							$ARCurrent->importStore->call("system.get.clone.phtml", $arCallArgs,
								$ARCurrent->importStore->get($newpath)));

					if (!($this->axflags & AX_WITHOUT_TEMPLATES)) {
						// (update or set templates and files)
						$this->call("system.export.templates.phtml", $arCallArgs);
					}
					if (!($this->axflags & AX_WITHOUT_FILES)) {
						$this->call("system.export.files.phtml", $arCallArgs);
					}
				}

			} else {
				if (!$ARCurrent->importStore->exists($newpath)) {
					display("(linking)");
					$ARCurrent->importStore->link($saved_object[$this->id], $newpath);
				}
			}
			display("\n");

			$check_path = $this->store->make_path($newpath, "..");
			$nextid_checks = $ARCurrent->nextid_checks;
			if ($oldpath!=$srcpath && !$nextid_checks[$check_path]) {
				$nextid_checks[$check_path] = true;
				$nextid = $this->store->get_nextid($this->store->make_path($oldpath, ".."));
				if ($nextid > 1) {
					$ARCurrent->importStore->set_nextid($check_path, $nextid);
					display("setting nextid ($nextid)\n");
				}
				$ARCurrent->nextid_checks = $nextid_checks;
			}
		} else {
			display("	skipping ($newpath)\n");
		}

		$items_processed = $this->getvar('items_processed');
		$items_processed++;
		progress($items_processed, $items_to_process);
		$this->putvar('items_processed',$items_processed);
