<?php

debug("pphoto: Load","object");
include_once($this->code."objects/pfile.phtml");

class pphoto extends pfile { // definitie class

	function convert($target) {
		global $AR;
		if (eregi('^(GIF|PNG|JPG|BMP)$',$target)) {
			$tmpsrc=$this->store->files."temp/".$this->id;
			$tmpdst=$tmpsrc.".".$target;
			$f_store=$this->store->get_filestore("files");
			$f_store->copy_from_store($tmpsrc, $this->id, "file");
			$f_store->close();
			if (chdir($this->store->files.'temp/')) {
				system($AR->IM->convert.' '.$this->id.' '.$this->id.'.'.$target, $failed);
				if (!$failed) {
					ob_start();
					readfile($tmpdst);
					$result=ob_get_contents();
					ob_end_clean();
				} else {
					$this->error="Could not run ImageMagick convert program";
				}
				@unlink($this->id);
				@unlink($this->id.$target);
			} else {
				$this->error="Could not change dir to ".$this->store->files."temp/ ";
			}
		} else {
			$this->error="Convert called with illegal target ($target), valid targets are: GIF, PNG, JPG or BMP";
		}
		return $result;
	}

	function scale($x, $y, $fillcolor=false) {
		global $AR;
		$x=(int)$x;
		$y=(int)$y;

		$tmpsrc=$this->store->files."temp/".$this->id;
		$f_store=$this->store->get_filestore("files");
		$f_store->copy_from_store($tmpsrc, $this->id, "file");
		$f_store->close();

		if (chdir($this->store->files.'temp/')) {
			$exec_string=$AR->IM->mogrify." -geometry ".$x."x".$y." -format jpg $this->id";
			system($exec_string,$failed);
			if (!$failed) {
				ob_start();
				readfile($tmpsrc.".jpg");
				$result=ob_get_contents();
				ob_end_clean();
			} else {
				$this->error="Could not run ImageMagick scale program (mogrify)<br>\n(".$exec_string.")";
				echo $this->error;
			}
			@unlink($tmpsrc);
			@unlink($tmpsrc.".jpg");
		} else {
			$this->error="Could not changedir to ".$this->store->files."temp/ ";
			echo $this->error;
		}

		return $result;
	}

	function _convert($target) {
		return $this->convert($target);
	}

	function _scale($x, $y, $fillcolor=false) {
		return $this->scale($x, $y, $fillcolor);
	}

	function get_thumb_settings() {
		global $ARConfig;
		return $ARConfig->cache[$this->path]->thumb;
	}

	function _get_thumb_settings() {
		return $this->get_thumb_settings();
	}

} // end class pphoto
?>