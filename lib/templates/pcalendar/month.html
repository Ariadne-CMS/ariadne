<?php
  /*
    arguments: 
      $date - unix time stamp, month set will be shown, highlights this day.
  */
  if ($this->CheckConfig($function, $args) && $this->CheckLogin("read")) {
    if (!$PHP_SELF) {
      global $PHP_SELF;
    }
    if (!$date) {
      $date=time();
    }
    
    // calculate first weekday of this month
    $date_arr=getdate($date);
    $starttime=mktime(0,0,0,$date_arr["mon"],1,$date_arr["year"]);
    $monthstart=getdate($starttime);
    $firstweekday=$monthstart["wday"];
    $endtime=mktime(0,0,0,$date_arr["mon"]+1,1,$date_arr["year"])-1;
    $monthend=getdate($endtime);
    $monthsize=$monthend["mday"];
    
    // is startdate in the current month -> highlight today.
    $today=getdate();
    if ($today["year"]==$date_arr["year"] && $today["mon"]==$date_arr["mon"]) {
      $current=$today["mday"];
    }
    $highlight=$date_arr["mday"];

    // now populate the month with all entries.

    function AddDay($from, $to, $priority, $path, $name, $summary) {
      global $ARCurrent;

      if ($from<=$to) {
        $from_arr=getdate($from);
        if ($from_arr["hours"]<12) {
          $ARCurrent->daylist[$from_arr["mday"]][0]="1";
        } else {
          $ARCurrent->daylist[$from_arr["mday"]][1]="1";
        }
      }
    }

    for ($i=1; $i<=$monthend["mday"]; $i++) {
      $ARCurrent->daylist[$i][0]="0";
      $ARCurrent->daylist[$i][1]="0";
    }
    unset($ARBeenHere["populate"]);
    $this->populate($starttime, $endtime, $data->min_priority["day"], "AddTime.phtml","timefunc=AddDay&from=$starttime&to=$endtime");
?>
<style>
<!--
  A.cal { text-decoration:none; } -->
</style>
<table border="0" cellspacing="0" cellpadding="0" bgcolor="#404074">
<tr>
  <td rowspan="3"><img src="<?php echo $AR->dir->images; ?>dot.gif" width="1" height="1" alt=""></td>
  <td><a href="<?php echo $PHP_SELF; ?>?date=<?php 
      echo mktime(0,0,0,$date_arr["mon"]-1,$date_arr["mday"],$date_arr["year"]); 
    ?>"><img src="<?php echo $AR->dir->images; ?>calendar/prev.gif" alt="<" border="0"></a></td>
  <td align="center"><font face="arial, helvetica" size="2" color="white"><b><?php 
      echo $date_arr["year"]." ".$date_arr["month"]; 
    ?></b></td>
  <td align="right"><a href="<?php echo $PHP_SELF; ?>?date=<?php 
      echo mktime(0,0,0,$date_arr["mon"]+1,$date_arr["mday"],$date_arr["year"]); 
    ?>"><img src="<?php echo $AR->dir->images; ?>calendar/next.gif" alt=">" border="0"></a></td>
  <td rowspan="3"><img src="<?php echo $AR->dir->images; ?>dot.gif" width="1" height="1" alt=""></td>
</tr><tr>
  <td bgcolor="white" colspan="3">
    <table border="0" cellspacing="2" cellpadding="2">
    <tr>
      <td bgcolor="#404074" align="center"><font face="arial, helvetica" size="2" 
        color="white"><b><?php echo $ARnls["sun"]; ?></b></font><br><img src="<?php echo $AR->dir->images; ?>dot.gif" width="32" height="1"></td>
      <td bgcolor="#404074" align="center"><font face="arial, helvetica" size="2" 
        color="white"><b><?php echo $ARnls["mon"]; ?></b></font><br><img src="<?php echo $AR->dir->images; ?>dot.gif" width="32" height="1"></td>
      <td bgcolor="#404074" align="center"><font face="arial, helvetica" size="2" 
        color="white"><b><?php echo $ARnls["tue"]; ?></b></font><br><img src="<?php echo $AR->dir->images; ?>dot.gif" width="32" height="1"></td>
      <td bgcolor="#404074" align="center"><font face="arial, helvetica" size="2" 
        color="white"><b><?php echo $ARnls["wed"]; ?></b></font><br><img src="<?php echo $AR->dir->images; ?>dot.gif" width="32" height="1"></td>
      <td bgcolor="#404074" align="center"><font face="arial, helvetica" size="2" 
        color="white"><b><?php echo $ARnls["thu"]; ?></b></font><br><img src="<?php echo $AR->dir->images; ?>dot.gif" width="32" height="1"></td>
      <td bgcolor="#404074" align="center"><font face="arial, helvetica" size="2" 
        color="white"><b><?php echo $ARnls["fri"]; ?></b></font><br><img src="<?php echo $AR->dir->images; ?>dot.gif" width="32" height="1"></td>
      <td bgcolor="#404074" align="center"><font face="arial, helvetica" size="2" 
        color="white"><b><?php echo $ARnls["sat"]; ?></b></font><br><img src="<?php echo $AR->dir->images; ?>dot.gif" width="32" height="1"></td>
    </tr><tr>
    <?php
//      for ($i=1; $i<=$firstweekday; $i++) {
      for ($i=$firstweekday; $i; $i--) {
        echo "<td align=\"center\" valign=\"middle\"><a href=\"$PHP_SELF?date=".
          mktime(0,0,0,$date_arr["mon"],(-$i+1),$date_arr["year"]).
          "\"><img src=\"".$AR->dir->images."dot.gif\" width=\"32\" height=\"20\" border=\"0\" alt=\"-$i\"></a></td>";
//        echo "  <td></td>\n";
      }
      for ($i=1; $i<=$monthsize; $i++) {
        $idate=mktime(0,0,0,$date_arr["mon"],$i,$date_arr["year"]);
        if ($i==$highlight) {
          echo "  <td bgcolor=\"#CCCCCC\">";
        } else {
          echo "  <td bgcolor=\"#EEEEEE\">";
        }
        echo "<img src=\"".$AR->dir->images."calendar/calmon".$ARCurrent->daylist[$i][0].$ARCurrent->daylist[$i][1].".gif\" align=\"right\">";
        echo "<font face=\"arial, helvetica\" size=\"2\">";
        if ($i==$current) {
          echo "<u><a class=\"current\" href=\"$PHP_SELF?date=$idate\">$i</a></u>";
        } else {
          echo "<a class=\"cal\" href=\"$PHP_SELF?date=$idate\">$i</a>";
        }
        echo "</font></td>\n";
        if ((($i+$firstweekday)%7)==0) { // end of the week, next row
          echo "</tr>";
          if ($i<$monthsize) { // only start a new row if there are more days
            echo "<tr>\n";
          }
        }
      }
      $date_arr=getdate(mktime(0,0,0,$date_arr["mon"]+1,1,$date_arr["year"]));
      $firstweekday=$date_arr["wday"]; // first week day of next month
      if ($firstweekday) { // if first weekday is sunday, then don't display empty line
        for ($i=1; $i<(8-$firstweekday); $i++) {
          echo "<td align=\"center\" valign=\"middle\"><a href=\"$PHP_SELF?date=".
            mktime(0,0,0,$date_arr["mon"],$i,$date_arr["year"]).
            "\"><img src=\"".$AR->dir->images."dot.gif\" width=\"32\" height=\"20\" border=\"0\" alt=\"$i\"></a></td>";
        }
      }
    ?>
    </tr>
    </table>
  </td>
</tr><tr>
  <td colspan="3"><img src="<?php echo $AR->dir->images; ?>dot.gif" width="1" height="1" alt=""></td>  
</tr>
</table>
<?php
  }
?>