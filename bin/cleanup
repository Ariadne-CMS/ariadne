#!/usr/bin/php -q
<?php
	$ariadne="../lib";
	require($ariadne."/configs/ariadne.phtml");
	require($ariadne."/configs/store.phtml");
	require($ariadne."/configs/sessions.phtml");
	require($ariadne."/includes/loader.cmd.php");
	require($store_config['code']."stores/".$store_config["dbms"]."store.phtml");


	echo "Clearing old sessions...";
	$inst_store = $store_config["dbms"]."store";
	$sessionstore=new $inst_store($root,$store_config);
	$criteria["object"]["lastchanged"]["<"]=strftime("%Y%m%d%H%M%S",time()-($session_config["timeout"]*4));
	$criteria["object"]["implements"]["="]="'psession'";
	$sessionstore->call("system.expire.phtml","",$sessionstore->find("/",$criteria, 0));
	echo $sessionstore->count." expired sessions removed.\n";
	$sessionstore->close();
	echo "done.\n";

	// clean up store temp directories
	if ($AR->OS=="UNIX") {
		echo "Clearing temporary files...";
		$tempdir=$store_config["files"]."temp/";
		if (file_exists($tempdir)) {
			system("find $tempdir -ctime 1 -mindepth 1 -exec rm {} ';'"); 
		}
		echo "done.\n";
	} else {
		// FIXME: so... how do you do this under windows?
	}
?>