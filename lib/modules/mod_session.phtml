<?php
class session {

	function session($session_config, $id=0) {
        debug("session([array],$id)","store");
		// init session store
		$inst_store = $session_config["dbms"]."store";
		include_once($session_config["code"]."stores/$inst_store.phtml");
		$this->sessionstore=new $inst_store($session_config["root"], $session_config);

		$this->timeout=$session_config["timeout"];

		if ((!$id) || (!$this->sessionstore->exists("/$id/")))  { 
			debug("session: generating new id", "all");
			// generate new id
			srand((double)microtime()*1000000);
			do { 
				// 3 bytes id
				$genid=chr(rand(1,255)).chr(rand(1,255)).chr(rand(1,255));
				// replace all slashes with "0" 
				$id=strtr(base64_encode($genid),"/+","01");
			} while ($this->sessionstore->exists("/".$id."/"));
			// save new session object
			$this->data=new object;
			$this->id=$id;
			$this->lastchanged=time();
			$this->system = new object;
			$this->system->ARSessionTimedout=false;
			$this->save();
		} else { // retrieve session
			$result=current($this->sessionstore->call(
													"system.get.session.phtml",
													"",
													$this->sessionstore->get("/$id/")
												));
			$this->id=$id;
			$this->lastchanged=$result->lastchanged;
			$this->system = $result->data->system;
			if (isset($this->system->timeout)) {
				$this->timeout = $this->system->timeout;
			}
			unset($result->data->system);
			if ($result->data->ARSessionTimedout || $this->timeout && $this->lastchanged < (time()-$this->timeout)) {
				debug("session: ".$this->id." ARSessionTimedout", "all");
				$this->system->ARSessionTimedout = true;
			}
			$this->data=$result->data;
		}

		$this->put("ARSessionId",$this->id);
        debug("session: end","all");
	}

	function put($varname, $value, $system=0) {
		debug("session->put($varname,$value,$system)","store");
		if (!$system) {
			if ($this->data->$varname !== $value) {
				$this->data->$varname=$value;
				$this->changed = true;
			}
		} else {
			if ($this->system->$varname !== $value) {
				$this->system->$varname=$value;
				$this->changed = true;
			}
		}
		debug("session->put: end","all");
	}

	function get($varname, $system=0) {
        debug("session->get($varname, $system)","store");
		if (!$system) {
			$result = $this->data->$varname;
		} else {
			$result = $this->system->$varname;
		}
        debug("session->get: end","all");
		return $result;
   	}

	function setTimeout($timeout = 0) {
		$this->put('timeout', $timeout, true);
	}

	function save($id=0, $forceupdate=0) {
        debug("session->save($id)","store");
		if (!$this->system->ARSessionTimedout || $forceupdate) {
			if (!$id) { $id=$this->id; } else { $this->id=$id; }
			// store session data
			$this->data->system = $this->system;

			if ($this->changed || $forceupdate) {
				$this->sessionstore->save("/$id/","psession",$this->data);
			} else {
				$this->sessionstore->touch("/$id/", time());
			}
			unset($this->data->system);
			$this->lastchanged=time();
		} else {
			debug("session timed out: no save!", "all");
		}
        debug("session->save: end","all");
	}


	function suspend() {
		debug("session->suspend()","store");
		$this->save();
		$this->sessionstore->close();
		$this->id=0;
        debug("session->suspend: end","all");
		ldSetSession();      
	}
 
	function kill() {
		debug("session->kill()","store");
		// remove session data from store
		$this->sessionstore->purge("/".$this->id."/");
		$this->sessionstore->close();
		$this->id=0;
		debug("session->kill: end","all");
		ldSetSession();
	}
}
?>