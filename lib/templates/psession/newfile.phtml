<?php
  if ($this->CheckLogin("add") && $this->CheckConfig()) {
    if (!$confirm) {
      // Check for .phtml files, disallow
      // 1. check file
      if (!$file) {
        global $file, $file_name, $file_size, $file_type;
      } else { // it seems somehow the rest is always available under php3...
        global $file_type;
      }
      if (!$file || !file_exists($file) || !$file_name || !$file_size || !$file_type) {
        $error=$ARnls["err:fileupload"];
      } else if (eregi(".*\.phtml$",$file_name)) {
        $error=$ARnls["err:fileuploadphtml"];
      } else {
        // 2. get filename and mimetype
        // 3. check if $path/filename exists
        if ($this->exists($this->path.$file_name."/")) {
          //    4 if exists : ask before overwrite
          // first move the file somewhere safe.
          $tempfile=$this->store->nextid("files");
          copy($file, $this->store->files."temp/".$tempfile);
          $arCallArgs.="&tempfile=$tempfile&file_name=".RawUrlEncode($file_name);
  	  $question=sprintf($ARnls["q:fileoverwrite"],$file_name);
  	  $buttons[]=$ARnls["donotoverwrite"];
  	  $buttons[]=$ARnls["overwrite"];
          include($this->store->code."includes/confirm.phtml");
        } else {
          if ($this->CheckLogin("add")) {
            //    5 if not exists : create pfile and display edit.phtml
            //    fill in name in all nls name variables
            reset($ARConfig->nls->list);
            while (list($language, $dummy)=each($ARConfig->nls->list)) {
              $names.="&$language"."[name]=".RawUrlEncode($file_name);
            }
            $returnpage=$this->store->root.$this->path.$file_name."/edit.phtml?returnpage=".RawUrlEncode($returnpage);
            $this->call("new.phtml","newtype=pfile&newfilename=".
               RawUrlEncode($file_name).$names.
               "&next=".RawUrlEncode($ARnls["save"])."&returnpage=".RawUrlEncode($returnpage));
          }
        }
      }
    } else { // confirm
      if ($confirm==$ARnls["overwrite"]) {
        copy($this->store->files."temp/".$tempfile, $this->store->files."files".$this->path.$file_name);
        Header("Location: ".$this->store->root.$this->path.$file_name.
          "/edit.phtml?returnpage=".RawUrlEncode($returnpage));
      } else {
        unlink($this->store->files."temp/".$tempfile);
        Header("Location: $returnpage");
      }
    }
    if ($error) {
      include($this->store->code."includes/error.phtml");
    }
  }
?>