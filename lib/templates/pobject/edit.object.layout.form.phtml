<?php
	/******************************************************************
	 edit.object.layout.form.phtml                         Muze Ariadne
	 ------------------------------------------------------------------
	 Arguments: $type, $function, $template, $mode
	 Grant needed: layout
	 Global variables: none

	 This template displays an object template defined at the current 
	 object in an editable textarea.

	 If the template is called without arguments, it will default to
	 an empty template with the class of the current object.
	 
	 no result

	******************************************************************/
	if ($this->CheckLogin("layout") && $this->CheckConfig()) {
?>
<html>
<head>
<title><?php printf($ARnls["edittemplate"],$this->path.$function); ?></title>
<?php
	include($this->store->get_config("code")."widgets/wizard/classic.css");
?>
<style>
  .full {
    width: 100%;
    height: 82%;
 }
  .templatefield {
    width: 100%;
    height: 99%;
  }
  .linenumbers {
    height:99%;
    width:50px;
    overflow:hidden;
  }
</style>
<script>
  function init() {
    <?php
	 if ($error) {
		 echo "alert('".AddCSlashes($error, ARESCAPE)."');\n";
	 }
	 if( !$mode || $mode == "edit" ) {
		 echo "document.forms[0].template.focus();";
		 if( $cursorpos ) {
		 	echo "setCursorPos(".$cursorpos.");";
		 }
	 }
    ?>
  }

function event_templatescroll(){
   scrollposition=document.all.template.scrollTop;
   document.all.linenumber.scrollTop=scrollposition;
}

function mode_change() {
	document.forms[0].action = "edit.object.layout.form.phtml";
	if( document.forms[0].mode[document.forms[0].mode.selectedIndex].value == 'highlight' ) {
		document.forms[0].action = "edit.object.layout.highlight.phtml";
	}
	document.forms[0].submit();
}

function setCursorPos(positie) {
	var template = document.forms[0].template;
	if( positie > template.value.length ) {
		return;
	}
	if( document.selection ) {
		var mtext=template.createTextRange();
		//~ mtext.collapse(true); // I think this is not needed
		mtext.moveStart('character', positie);
		mtext.collapse(true);
		mtext.select();
	} else {
		// do something Mozilla style
		template.focus();
		template.setSelectionRange(positie, positie);
	}
}

function getCursorPos() {
	var template = document.forms[0].template;
	if (document.selection) {
		var mtext=document.selection.createRange();
		var count=0;
		var moved=0;
		while (moved=mtext.moveStart('character', -100)) {
			count-=moved;
		}
		return (count-70); // off by 70?! At least it's always off by 70 :) FIXME seems in order
	} else {
		var selection=window.getSelection();
		if (selection.anchorNode) {
			var len = template.selectionEnd;
			return len;
		}
	}
}

function saveCursorPos() {
	var positie = getCursorPos();
	document.forms[0].cursorpos.value = positie;
	return true;
}

/**
* Insert a tab at the current text position in a textarea
* Jan Dittmer, jdittmer@ppp0.net, 2005-05-28
* Inspired by http://www.forum4designers.com/archive22-2004-9-127735.html
* Tested on: 
*   Mozilla Firefox 1.0.3 (Linux)
*   Mozilla 1.7.8 (Linux)
*   Epiphany 1.4.8 (Linux)
*   Internet Explorer 6.0 (Linux)
* Does not work in: 
*   Konqueror (no tab inserted, but focus stays)
*/
function insertTab(event,obj) {
	var tabKeyCode = 9;
	var escapeKeyCode = 27;
	if (event.which) // mozilla
		var keycode = event.which;
	else // ie
		var keycode = event.keyCode;
	if (keycode == tabKeyCode) {
		if (event.type == "keydown") {
			if (obj.setSelectionRange) {
				// mozilla
				var scrollTop = obj.scrollTop;
				var s = obj.selectionStart;
				var e = obj.selectionEnd;
				obj.value = obj.value.substring(0, s) + 
					"\t" + obj.value.substr(e);
				obj.setSelectionRange(s + 1, s + 1);
				obj.focus();
				obj.scrollTop=scrollTop;
			} else if (obj.createTextRange) {
				// ie
				document.selection.createRange().text="\t"
				obj.onblur = function() { this.focus(); this.onblur = null; };
			} else {
				// unsupported browsers
			}
		}
		if (event.returnValue) // ie ?
			event.returnValue = false;
		if (event.preventDefault) // dom
			event.preventDefault();
		return false; // should work in all browsers
	} else if (keycode == escapeKeyCode) {
		if (event.returnValue) // ie ?
			event.returnValue = false;
		if (event.preventDefault) // dom
			event.preventDefault();
		return false; // should work in all browsers
	}
	return true;
}


</script>
</head>
<script src="<?php echo $AR->dir->www; ?>widgets/window/savesize.js"></script>
<body onload="init();">
<?php
	if( $newtype ) { 
		$type = $newtype; 
	}
	if( $newfunction ) {
		$function = $newfunction;
	}
	if( $newlanguage ) {
		$language = $newlanguage;
	}
?>
<form action="edit.object.layout.save.phtml" method="post" style="height: 100%;">
<input type="hidden" name="type" value="<?php echo $type; ?>">
<input type="hidden" name="function" value="<?php echo $function; ?>">
<input type="hidden" name="language" value="<?php echo $language; ?>">
<input type="hidden" name="cursorpos" value="<?php echo $cursorpos; ?>">
<table border="0" width="100%" cellspacing="0" height="5%">
	<tr>
		<td>
			<span class="required"><?php echo $ARnls["type"]; ?></span>
		</td><td>
			<span class="required"><?php echo $ARnls["template"]; ?></span>
		</td><td>
			<span class="required"><?php echo $ARnls["language"]; ?></span>
		</td><td>
			<span class="required"><?php echo $ARnls["mode"]; ?></span>
		</td><td>
		</td>
	</tr><tr>
		<td>
			<select name="newtype">
			<?php
				//$this->ls("/system/ariadne/types/", "show.option.value.phtml","selected=$type");
				$this->call('typetree.ini');
				asort($ARCurrent->arTypeNames);
				foreach ($ARCurrent->arTypeNames as $typeValue => $typeName) {
					if ($type == $typeValue) {
						$selected = " selected";
					} else {
						$selected = "";
					}
					echo "<option value=\"$typeValue\"$selected>$typeName</option>\n";
				}
			?>
			</select>
		</td><td>
			<input type="text" name="newfunction" value="<?php echo $function; ?>">
		</td><td>
			<select name="newlanguage">
			<option value="any"><?php echo $ARnls["any"]; ?></option>
			<?php
				while (list($key, $value)=each($AR->nls->list)) {
					if ($language==$key) {
						echo "<option value=\"$key\" selected>$value</option>\n";
					} else {
						echo "<option value=\"$key\">$value</option>\n";
					}
				}				
			?>
			</select>
		</td><td>
			<select name="mode" onchange="mode_change();">
				<option value="highlight" <?php if( $mode == "highlight" ) echo "selected"; ?>><?php echo $ARnls["highlight"]; ?></option>
				<option value="edit" <?php if( !$mode || $mode == "edit" ) echo "selected"; ?>><?php echo $ARnls["edit"]; ?></option>
			</select>
		</td><td>
			<?php 
				if ($data->config->templates[$type][$function][$language] || !$function) {
					$default=1;
				}
			?>
			<input type="checkbox" name="default" value="1" <?php 
				if ($default) { echo " checked"; } ?>>
			<span class="required"><nobr><?php echo $ARnls["default"]; ?></nobr></span>
		</td>
	</tr>
</table>
<?php
	if (!($file=$template)) {
		if ($data->config->pinp[$type][$function][$language]) {
			$template=$type.".".$function.".".$language.".pinp";
			$templates=$this->store->get_filestore("templates");
			if ($templates->exists($this->id, $template)) {
				$file=$templates->read($this->id, $template);
			}
		}
	}
	
	
	if( $mode == "highlight" ) {

		$hfile = $file;
		
?>
<table border="0" width="100%" cellspacing="0" class="full">
<input type="hidden" name="template" value="<?php echo str_replace('"', "&quot;", $file); ?>">
<tr height="100%"><td>
<div style="width: 100%; height: 100%; overflow: auto; border: 2px inset buttonhighlight;">
<code style="word-break: keep-all; white-space: nowrap;"><ol><li><?php
	

	$hfile = str_replace("<pinp>", "<?php", $hfile);
	$hfile = str_replace("</pinp>", "?>", $hfile);
	
	$hfile = highlight_string($hfile, true );
	
	$hfile = str_replace("&lt;?php", "&lt;pinp&gt;", $hfile);
	$hfile = str_replace("?&gt;", "&lt;/pinp&gt;", $hfile);
	
	$hfile = str_replace("&lt;?</font><font color=\"#0000BB\">php", "&lt;</font><font color=\"#0000BB\">pinp&gt;", $hfile);
	
	$hfile = str_replace("<br />", "</code></li><li><code style=\"word-break: keep-all; white-space: nowrap;\">", $hfile);
	echo $hfile;
?></li></ol></code>
</div>
</td></tr>
</table>
<?php	
	} else {
?>
<table border="0" width="100%" cellspacing="0" class="full"> 
<tr><td valign="top">

<textarea name="linenumber" id="linenumber"  wrap="off" readonly class="linenumbers" tabindex="-1">
<?php
	$file=ereg_replace("&","&amp;",$file);
	$file=ereg_replace("<","&lt;", ereg_replace(">","&gt;",$file));

	$linetotal = 1;
	$linetotal = substr_count( $file, "\n");

	  for( $i=1;$i<($linetotal+500);$i++) {
	     echo("$i\n");
	  }
?>
</textarea>
</td><td width="100%">
<div style="height: 100%;">
<textarea onkeydown="return insertTab(event,this);" onkeyup="return insertTab(event,this);" onkeypress="return insertTab(event,this);" cols="78" rows="20" name="template" id="template" wrap="off" class="templatefield" onscroll="event_templatescroll();"><?php
        echo $file;
?></textarea>
</div>
</td></tr></table>
<?php
	}
?>
<table border="0" width="100%" height="10%" cellspacing="0">
<tr>
	<td colspan="2" valign="top">
		<input type="submit" name="next_cancel" value="<?php echo $ARnls["cancel"]; ?>">
		<input type="submit" name="next_delete" value="<?php echo $ARnls["delete"]; ?>" 
		 onClick="return confirm('<?php echo $ARnls["q:removethistemplate"]; ?>');">
	</td><td colspan="2" align="right" valign="top">
		<input type="submit" name="next_apply" value="<?php echo $ARnls["apply"]; ?>" onclick="return saveCursorPos();" unselectable=on>	
		<input type="submit" name="next_save" value="<?php echo $ARnls["save"]; ?>">	
	</td>
</tr>
</table>
</form>
</body>
<?php 
	} 
?>