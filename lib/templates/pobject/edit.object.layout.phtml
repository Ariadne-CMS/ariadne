<?php
	/******************************************************************
	 edit.object.layout.phtml                              Muze Ariadne
	 ------------------------------------------------------------------
	 Arguments: none
	 Grant needed: layout
	 Global variables: none

	 This template displays a list of object templates defined at the
	 current object. It displays a list of clickable flags denoting the
	 different languages for which the template is defined, linked to
	 the template edit form for that template in that language.
	 
	 no result

	******************************************************************/
	if ($this->CheckLogin("layout") && $this->CheckConfig()) {
		if ($AR->user->data->template_editor=='helene') {
			$mode="highlight"; // helene
			$editor="edit.object.layout.highlight.phtml";
		} else {
			$mode="edit"; // textarea
			$editor="edit.object.layout.form.phtml";
		}

		$this->call('typetree.ini');
		$icons = $ARCurrent->arTypeIcons;
		$names = $ARCurrent->arTypeNames;

?>
<html>
<head>
<title><?php echo $ARnls["templates"] . ' ' . $this->path; ?></title>
<link rel="stylesheet" type="text/css" href="<?php echo $AR->dir->styles; ?>form.css">
<style>
	.required {
		background-color: buttonface;
		border: 2px outset;
		padding: 2px;
		font-weight: bold;
	}	
	.required div {
		width: 100%;
	}
	td.type {
		width: 22px;
		padding-left: 2px;
	}
	a.button {
		border: 1px outset;
	}
	input {
		width: 75px;
	}
</style>
<script src="<?php echo $AR->dir->www; ?>widgets/window/savesize.js"></script>
<script src="<?php echo $AR->dir->www; ?>widgets/webfx/tablesort/tablesort.js"></script>
<link rel="stylesheet" type="text/css" href="<?php echo $AR->dir->www; ?>widgets/webfx/tablesort/tablesort.css">
</head>
<body bgcolor="white">
<script>
	if (document.all) {
		window.innerHeight=document.body.clientHeight;
		window.innerWidth=document.body.clientWidth;
	}	
</script>
<div style="height: 95%;">
<table border="0" width="100%" height="100%" align="center" cellspacing="2" vspace="10" hspace="10">
<tr>
	<td colspan="3" bgcolor="white" style="border: 2px inset; padding: 0px;" height="90%" valign="top">

	<div style="height: 100%; width: 100%; overflow: auto; margin: 0px; border: 0px;">
		<table border="0" background="<?php echo $AR->dir->www; ?>widgets/webfx/tablesort/tablebackground.jpg" bgcolor="white" width="100%" cellspacing="0" cellpadding="0" onclick="sortColumn(event)">
		<thead style="cursor:hand;">
		<tr>    
			<td valign="top" class="required">
				<?php echo $ARnls["type"]; ?>
			</td><td valign="top" class="required">
				<?php echo $ARnls["template"]; ?>
			</td><td valign="top" class="required">
				<?php echo $ARnls["language"]; ?>
			</td><td valign="top" class="required">
				<?php echo $ARnls["size"]; ?>
			</td><td valign="top" class="required">
				<?php echo $ARnls["modified"]; ?>
			</td>
		</tr></thead><tbody><?php
			$svn_enabled = false;
			$repository = $this->data->svn;

			if (isset($repository)) {
				$svn_enabled = true;
				$filestore = $this->store->get_filestore_svn("templates");

				$svnstack = &PEAR_ErrorStack::singleton('VersionControl_SVN');
				$svn = $filestore->connect($this->id, $repository, "", "");
				$svn_status = $filestore->svn_status($svn);
			} else {
				$filestore = $this->store->get_filestore("templates");
			}


			//$filestore = $this->store->get_filestore("templates");
			if (!function_exists("layout_sortfunc")) {
				function layout_sortfunc($a, $b) {
				   if ($a == $b) {
				       return 0;
				   }
				   return ($a < $b) ? -1 : 1;
				}
			}


			$pinp = $data->config->pinp;

			if ($svn_enabled) {
				if ($svn_status) {
					foreach ($svn_status as $filename=>$file_status) {
						if ($file_status == "!") {
							// Template is deleted here, but not in the SVN.
							$file_meta = array();
							$file_meta['ar:default'] = $filestore->svn_propget($svn, "ar:default", $filename);
							$file_meta['ar:type'] = $filestore->svn_propget($svn, "ar:type", $filename);
							$file_meta['ar:function'] = $filestore->svn_propget($svn, "ar:function", $filename);
							$file_meta['ar:language'] = $filestore->svn_propget($svn, "ar:language", $filename);

							$pinp[$file_meta['ar:type']][$file_meta['ar:function']][$file_meta['ar:language']] = $this->id;
						}
					}
				}
			}

			if (($pinp) && is_array($pinp)) {
				while (list($type, $values)=each($pinp)) {
					uksort($values, 'layout_sortfunc');	
					while (list($function, $templatelist)=each($values)) {
						ksort($templatelist);
						reset($templatelist);
						$language = key($templatelist);

						if ($svn_enabled) {
							$filename = $type . "." . $function . "." . $language . ".pinp";
							if ($svn_status) {
								$svn_style = "";
								$svn_img = "";

								switch($svn_status[$filename]) {
									// Fixme: find out the codes for "locked", "read only" and add them.

									case "C":
										$svn_img = "ConflictIcon.png";
										break;
									case "M":
										$svn_img = "ModifiedIcon.png";
										break;
									case "?":
										break;
									case "A":
										$svn_img = "AddedIcon.png";
										break;
									case "D":
										$svn_img = "DeletedIcon.png";
									case "!":
										$svn_style = "opacity: 0.3; filter: alpha(opacity=30);";
										break;
									default:
										$svn_img = "InSubVersionIcon.png";
										break;
								}
							}
						}

						$onclick = "document.location='".$editor."?mode=".$mode."&type=".$type."&function=".RawUrlEncode($function)."&language=".$language."'";
						$icon_src = $icons[$type]['small'];						
						?><tr style="<?php echo $svn_style;?>" valign="middle" onmouseover="style.backgroundColor='steelblue',style.color='white'" onmouseout="style.color='',style.backgroundColor='';" onclick="<?php echo $onclick; ?>">
						       <td align="left" valign="middle" style="height:23px">
								<img src="<?php echo $icon_src; ?>" width="20" height="20" align="absmiddle">
								
								<?php
									if ($svn_enabled) {
										if ($svn_img) {
											$svn_img_src = $AR->dir->images . "/svn/$svn_img";
											?><img width=12 height=12 style="position: relative; top: 4px;" src="<?php echo $svn_img_src;?>"><?php
										}
									}
								?>

								<?php echo $type; ?>&nbsp;</td>
							<td align="left"><div style="display:none;"><?php echo $function; ?></div><?php  
								if (!$data->config->templates[$type][$function]) {
									echo "<img src='{$AR->dir->images}local.gif' alt='local' height='12' width='11'>";	
								}
							?>
							<?php echo $function; ?></td>
							<td><?php
								ksort($templatelist);
								reset($templatelist);
								while (list($language, $template)=each($templatelist)) {
									
									$flag="<img src=\"".$AR->dir->images."nls/small/$language.gif\" alt=\"".$AR->nls->list[$language]."\" border=\"0\">";
									echo "<a class=\"button\" href=\"".$editor."?mode=".$mode."&type=".$type."&function=".RawUrlEncode($function).
										"&language=".$language."\">$flag</a> ";
								}
							?></td>
								<?php
									$tbasename = "$type.$function";
									reset($templatelist);
									$mtime = 0;
									$msize = 0;
									while (list($language, $template)=each($templatelist)) {
										$time = $filestore->mtime($this->id, "$tbasename.$language.pinp");
										if ($time > $mtime) {
											$mtime = $time;
										}
										$size = $filestore->size($this->id, "$tbasename.$language.pinp");
										if( $size > $msize) {
											$msize = $size;
										}

									}

								?>
							<td>
								<div style="display:none;"><?php printf("%010d", $msize); ?></div><?php echo $this->make_filesize($msize); ?>&nbsp;
							</td>
							<td>
								<div style="display:none;"><?php print $mtime; ?></div>
								<?php echo strftime("%H:%M", $mtime); ?>&nbsp;&nbsp;
								<?php echo strftime("%d %b %Y", $mtime); ?>&nbsp;
							</td>

						</tr><?php
					}
				}
			}
		?></tbody>
		</table>
	</div>
	</td>
</tr><tr>
	<td valign="bottom"><input type="button" name="action" value="<?php echo $ARnls["cancel"]; ?>" onClick="window.close();"></td>
	<td align="left" valign="bottom"><?php
		if ($AR->Grep->path) {
			?>
		<form action="edit.object.layout.grep.phtml"><input type="text" name="search" value="<?php echo $search; ?>" style="width: 200px;"><input type="submit" name="grep" value="Grep"></form>
			<?php
		}
			?>
		</td>
	</td>
	<td align="right" valign="bottom"><form action="<?php echo $editor.'?'.$mode; ?>">
		<input type="hidden" name="type" value="<?php echo $this->type; ?>">
		<input type="submit" name="action" value="<?php echo $ARnls["new"]; ?>"></form></td>
</tr>
	<?php
		if ($svn_enabled) {
	?>
<tr>
<td colspan="3">
	<form style="float: left; margin-right: 5px;" action="svn.checkout.html"><input type="submit" name="svn_update" value="Checkout"></form>
	<form style="float: left; margin-right: 5px;" action="svn.commit_all.html"><input type="submit" name="svn_commit" value="Commit"></form>
	<form style="float: left; margin-right: 5px;" action="svn.update.html"><input type="submit" name="svn_update" value="Update"></form>
	<form style="float: left; margin-right: 5px;" action="svn.diff.html"><input type="submit" name="svn_diff" value="Diff"></form>
	<form style="float: left; margin-right: 5px;" action="svn.import.html"><input type="submit" name="svn_import" value="Import"></form>
	<form style="float: left; margin-right: 5px;" action="svn.revert_all.html"><input type="submit" name="svn_revert" value="Revert"></form>
	<form style="float: left; margin-right: 5px;" action="svn.config.html"><input type="submit" name="svn_config" value="Config"></form>
</td>
</tr>
	<?php
		} else {
			if ($this->data->custom['none']['svn']) {
	?>
<tr>
<td colspan="3">
	<form style="float: left; margin-right: 5px;" action="svn.config.html"><input type="submit" name="svn_config" value="Config"></form>
</td>
</tr>
	
	<?php
			}
		}
	?>


</table>
</div>
</body>
<?php
	}
?>
