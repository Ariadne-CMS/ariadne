<?php
/***********************************************************************
	Ariadne Export file manager

	(We could use the Zlib module for php -compression module- but is
	it also supported on the windows platform? Check it out.)

************************************************************************/
class mod_ax {

	function open($exportfile,$mode="unpack",$tempdir="/tmp/") {
		$this->tempdir=tempnam($tempdir,"export_");
		$this->exportfile=$exportfile;

		if (!file_exists($this->tempdir)) {
			mkdir($this->tempdir,0777);
		}
		if ($mode=="unpack") {
			// tar will (g)unzip and untar the file into tempdir 
			$command="tar -zxf $exportfile -C ".$this->tempdir;
			@system($command,$retVar);
			if ($retVar!=0) {
				$result="err:cannotuntar";
			}
		}
		
		return $result;
	}

	function MkDir($path) {
		$paths=explode("/",$path);
		while (is_array($paths) && (list($key,$path)=each($paths))) {
			$curr.="/".$path;
			if (!file_exists($curr)) {
				if (!@mkdir($curr,0755)) {
					$result="err:cannotmakedir";
					break;
				}
			}
		}
		return $result;
	}

	// remove directories with content
	function RmDir($path) {
		if ($path[strlen($path)-1]!="/") {
			$path.="/";
		}

		if (!($dh=opendir($path))) {
			$result="err:cannotopendir";
		} else {
			while ($file=readdir($dh)) {
				if (($file!=".") && ($file!="..")) {
					$file=$path.$file;
					if (is_dir($file)) {
						if  ($result=$this->RmDir($file."/")) {
							break;
						}
					} else {
						if (unlink($file)===false) {
							$result="err:cannotunlink";
							break;
						}
					}
				}
			}
			closedir($dh);
			if (!$result) { 
				if (rmdir($path)===false) {
					$result="err:cannotremovedir";
				}
			}
		}
		return $result;
	}

	function importfiles($type,$path) {
		if (!($result=$this->MkDir($path))) {
			if (file_exists($this->tempdir."/$type.tgz")) {
				$command="tar -C $path -zxf ".$this->tempdir."/$type.tgz";
				@system($command,$retVar);
				if ($retVar!=0) {
					$result="err:cannotimport";
				}
			}
		}
		return $result;
	}

	function exportfiles($type,$path) {
		if (file_exists($path)) {
			$path2=substr($path,$rpos=strrpos(substr($path,0,-1),"/")+1);
			$path=substr($path,0,$rpos);
			$command="tar -zc -C $path $path2 -f ".$this->tempdir."/$type.tgz";
			@system($command,$retVar);
			if ($retVar!=0) {
				$result="err:cannotexport";
			}
		}
		return $result;
	}

	function close() {
		if (!($dh=opendir($this->tempdir))) {
			$result="err:cannotopentempdir";
		} else {
			while ($data=readdir($dh)) {
				if (($data!='.') && ($data!='..')) 
					$exp.=" $data ";
			}
			closedir($dh);

			$command="tar -zc -C ".$this->tempdir." $exp  -f ".$this->exportfile;

			@system($command,$retVar);
			if ($retVar!=0) {
				$result="err:cannotmakeax";
			} else {
				$result=$this->RmDir($this->tempdir);
			}
		}
		return $result;
	}
}
?>